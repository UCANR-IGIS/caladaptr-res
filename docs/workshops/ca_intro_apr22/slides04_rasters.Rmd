---
title: "<span style='color:#444; font-size:80%;'>Working with Cal-Adapt Climate Data in R: </span><br/>Rasters"
pagetitle: "Rasters"
author: "<a href='https://ucanr-igis.github.io/caladaptr/' target='_blank' rel='noopener'><img src='images/caladaptr-hexlogo_173x200.gif' style='height:120px; width:104px; padding:1em;'/></a>"
date: "<div style='width:900px; margin:0 auto;'><img src='images/igis-logo_550x58x256.png' style='padding:1em; float:left;'/><img src='images/cal-adapt-logo.svg' style='height:60px; padding:1em; float:right;'/></div>"
output: 
  slidy_presentation: 
    self_contained: no
    lib_dir: lib
    keep_md: no
    smart: no
    df_print: paged
    css: z_slidy.css
    footer: "<a href='index.html' style='color:#777; margin-left:2em;'>Working with Cal-Adapt Climate Data in R</a>"
    includes:
      in_header: gtag_caladaptr-res.js
---

# Why Rasters?

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(caladaptr)
library(DiagrammeR)  ## has a conflict with leaflet, must go high up in the pecking order
library(knitr)
library(kableExtra)
library(magrittr)
library(dplyr)
library(tidyr)
library(sf)
library(leaflet)
library(tmap)
library(htmltools)
```

```{js echo = FALSE}
w3c_slidy.mouse_click_enabled = false;
```

<div style="display: flex;">

<div style="width:400;">
Climate data are inherently raster

Rasters can cover large areas

Download once, use many times

Easy to query locations

Well-developed tools for manipulating and analyzing raster data
</div>

<div style="width:310px;">
<img src="./images/gcm-grid_300x300x256.png" style="width:300px; height:300px;">
</div>

</div>

# Challenges with Climate Rasters

Large file sizes

Many layers and/or many files

Analysis of multiple futures

File format limitations (especially TIFs)

Usual spatial data headaches (CRS, resolution)

# Download Options

```{r getting_data_options, echo=FALSE, results='asis', cache=TRUE}
tbl_vec <- c("Feature", "Cal-Adapt website", "Cal-Adapt FTP", "caladapt-py",
             "caladaptR",
             
             "Download rasters", "", "", "", "",
             "Statewide", "<span class='chk'>&#10004;</span>", "<span class='chk'>&#10004;</span>", "<span class='chk'>&#10004;</span>", "<span class='chk'>&#10004;</span>",
             "User area-of-interest", "<span class='chk'>&#10004;</span>", "", "<span class='chk'>&#10004;</span>", "<span class='chk'>&#10004;</span>",
             "10 recommended GCMs", "<span class='chk'>&#10004;</span>", "<span class='chk'>&#10004;</span>", "<span class='chk'>&#10004;</span>", "<span class='chk'>&#10004;</span>",
             "All 32 GCMs", "", "<span class='chk'>&#10004;</span>", "<span class='chk'>&#10004;</span>", "")

tbl_mat <- matrix(tbl_vec, byrow=TRUE, ncol=5)

knitr::kable(tbl_mat, format = "html", align = c("l", "c", "c", "c", "c"), 
             table.attr="class='borderme'", escape = FALSE) %>% 
  column_spec(1, width = "15em") %>%
  row_spec(1, bold=TRUE, background = gray(0.80), color = "black", align = "c", extra_css = "padding:0.5em 1em;") %>%
  row_spec(2, bold=TRUE, background = gray(0.9), italic = TRUE) %>% 
  kable_styling(full_width = FALSE)

```

\

![](images/caladaptpy-logo.svg){style='height:70px;'}

https://ucanr-igis.github.io/caladapt-py/

<div class="indented1 li-single">
- Jupyter Notebooks  
- ArcGIS Pro toolbox  
- workshop recordings on YouTube
</div>

\

<center>![](images/python_toolbox_351x333.png) ![](images/voxel_694x540.jpg){style="margin-left:2em; height:333px;"}</center>

# Getting Rasters with caladaptR 

## Approach

<div class="indented1">

The same API Request object can be used to fetch rasters

\

`ca_getrst_stars()`

<div class = "indented1 li-single">
- save TIFs to disk
- save image metadata in sidecar files
</div>

\

Custom function to import TIFs and their metadata into R as [stars](https://r-spatial.github.io/stars/){target="_blank" rel="noopener"} objects

\

Use stars methods for analysis:

<div style="display: flex;">

<div class = "indented1 li-single" style="width:360;">
- dplyr style filtering
- spatial overlay / extract
- raster algebra  
- pixelwise summaries  
- spatial manipulations  
- plotting
</div>

<div style="width:390px;">
<a href="https://r-spatial.github.io/stars/" target="_blank" rel="noopener"><img src="images/stars_cube_384x200x256.png" style="width:384px;"/></a>
</div>

</div>

\

Convenience functions to help manage stars objects:

<div class = "indented1 li-single">
- create index
- multiple rasters &rarr; 6D array
- mosaic
</div>

</div>

\

# Rasters Workflow

```{r rst_wrkflw, echo = FALSE, results = "asis"}
img_fns <- paste0("./images/rstwrkflw_0", 1:2, ".png")
htmltools::tagList(wrkshputils::wu_img_build(img_fns, display_first = TRUE, center = TRUE))
```

## Vignettes

<div class="indented2">
[Rasters Part I: Download, Combine, Subset, and Compute Pixel Summaries](https://ucanr-igis.github.io/caladaptr/articles/rasters-pt1.html){target="_blank" rel="noopener"}

[Rasters Part II: Six-Dimensional Climate Data Cubes and Spatial Queries](https://ucanr-igis.github.io/caladaptr/articles/rasters-pt2.html){target="_blank" rel="noopener"}

[Rasters Part III: Downloading Rasters for Large Areas](https://ucanr-igis.github.io/caladaptr/articles/rasters-pt3.html){target="_blank" rel="noopener"}
</div>

# Notebook 4: Rasters

<div class="indented2">

In Notebook 4 you will:

<div class="indented2">
- query using a sf polygon object
- download climate data as stars rasters  
</div>

[Notebook 4. Rasters](./notebooks/nb04_rasters.nb.html){target="_blank" rel="noopener"} | [solutions](./notebooks/nb04_rasters_ans.nb.html){target="_blank" rel="noopener"}

</div>

# END!